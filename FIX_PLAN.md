# 数独游戏逻辑错误修复计划

## 概述
本文档详细描述了修复数独游戏中发现的逻辑错误的实施计划，不包括挖空算法优化（问题5）。

## 修复项目列表

### 1. 修复重复重置保护机制冲突
**问题位置**：
- `main.js:160` - 使用 `window._isResetting`
- `board-renderer.js:26` - 使用 `isResetting`

**问题描述**：
两个不同的重置保护机制可能导致状态不一致。

**修复方案**：
1. 在 `board-renderer.js` 中使用统一的重置状态
2. 通过事件总线或共享状态管理重置状态
3. 移除 `window._isResetting` 的使用

**实施步骤**：
1. 在 `event-bus.js` 中添加全局状态管理
2. 修改 `board-renderer.js` 使用共享状态
3. 修改 `main.js` 移除本地重置标志

---

### 2. 修复预填格子数据存储问题
**问题位置**：
- `board-renderer.js:244-252`

**问题描述**：
预填格子的值只存储在 `textContent` 中，可能导致数据读取不准确。

**修复方案**：
1. 将预填格子的值同时存储在 `dataset` 中
2. 修改读取逻辑优先使用 `dataset` 值

**实施步骤**：
1. 修改 `renderBoard` 函数，为预填格子添加 `data-value` 属性
2. 修改 `readUserBoard` 函数，优先读取 `data-value`

---

### 3. 添加事件监听器清理机制
**问题位置**：
- `main.js:208-236` - 语言切换事件监听器
- 其他模块可能也存在类似问题

**问题描述**：
事件监听器重复添加和移除可能导致内存泄漏。

**修复方案**：
1. 创建统一的监听器管理器
2. 在模块卸载时清理所有监听器
3. 添加防御性检查

**实施步骤**：
1. 创建 `utils/listener-manager.js`
2. 在相关模块中使用管理器
3. 添加清理函数

---

### 4. 修复 i18n 加载竞态条件
**问题位置**：
- `i18n.js:8-28` - `loadTranslations` 函数

**问题描述**：
多个 `loadTranslations` 调用可能同时进行。

**修复方案**：
1. 使用 Promise 缓存机制
2. 添加加载状态跟踪
3. 防止重复加载

**实施步骤**：
1. 添加 `_loadingPromises` 对象缓存正在进行的加载
2. 修改 `loadTranslations` 使用缓存
3. 添加加载队列机制

---

### 5. 实现事件总线清理机制
**问题位置**：
- `event-bus.js` - 缺少 `off` 方法
- `main.js` - 注册的监听器没有清理

**问题描述**：
事件监听器注册后没有清理机制，可能导致内存泄漏。

**修复方案**：
1. 为 `event-bus.js` 添加 `off` 方法
2. 添加 `clearAll` 方法清理所有监听器
3. 在适当位置调用清理

**实施步骤**：
1. 扩展 `event-bus.js` 添加清理功能
2. 修改各模块保存监听器引用
3. 在 `handleClearRecords` 等位置调用清理

---

## 实施顺序

1. **第一阶段**：修复基础问题
   - 修复 i18n 加载竞态条件（独立性强）
   - 实现事件总线清理机制（基础功能）

2. **第二阶段**：修复模块间问题
   - 修复重复重置保护机制（需要协调多个模块）
   - 修复预填格子数据存储（单一模块）

3. **第三阶段**：完善和测试
   - 添加事件监听器清理机制（全局性改动）
   - 全面测试修复效果

## 测试计划

1. **单元测试**
   - 测试重置功能不再重复触发
   - 测试预填格子数据正确读取
   - 测试语言切换无内存泄漏

2. **集成测试**
   - 测试完整游戏流程
   - 测试多语言切换
   - 测试页面长期运行的内存使用

3. **边界测试**
   - 快速切换语言
   - 快速重置游戏
   - 长时间游戏后检查内存

## 风险评估

1. **低风险**：
   - i18n 竞态修复
   - 事件总线功能扩展

2. **中等风险**：
   - 重置机制统一（可能影响用户体验）
   - 预填格子存储改变（需确保向后兼容）

3. **缓解措施**：
   - 保留原有功能作为备用
   - 逐步替换而非一次性修改
   - 添加详细日志记录

## 完成标准

1. 所有功能正常运行
2. 无控制台错误或警告
3. 内存使用稳定
4. 测试用例全部通过
5. 代码审查通过