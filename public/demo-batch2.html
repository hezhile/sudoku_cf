<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>æ‰¹æ¬¡ 2 æ¼”ç¤º - æ•°ç‹¬æ¸¸æˆ</title>
<link rel="stylesheet" href="/css/styles.css">
<style>
  .demo-info {
    background: var(--bg-records);
    padding: 16px;
    margin-bottom: 16px;
    border-radius: 8px;
    border: 1px solid var(--border-normal);
  }
  .demo-info h2 {
    margin-top: 0;
    font-size: 18px;
  }
  .demo-info ul {
    margin: 8px 0;
    padding-left: 20px;
  }
</style>
</head>
<body>
  <div class="main-container">

    <!-- æ¼”ç¤ºä¿¡æ¯ -->
    <div class="demo-info">
      <h2>ğŸ§ª æ‰¹æ¬¡ 2 æ¼”ç¤º</h2>
      <p>è¿™ä¸ªé¡µé¢ç”¨äºæµ‹è¯• UI å’Œå­˜å‚¨æ¨¡å—</p>
      <ul>
        <li>âœ… æ£‹ç›˜æ¸²æŸ“å’Œäº¤äº’</li>
        <li>âœ… è®¡æ—¶å™¨åŠŸèƒ½</li>
        <li>âœ… æ§åˆ¶æŒ‰é’®</li>
        <li>âœ… æœ¬åœ°å­˜å‚¨</li>
      </ul>
    </div>

    <!-- å¤´éƒ¨ -->
    <div class="header-section">
      <h1>æ•°ç‹¬ Sudoku</h1>
    </div>

    <!-- æ¸¸æˆæ§åˆ¶ + è®¡æ—¶å™¨ -->
    <div class="controls-bar">
      <select id="difficulty" class="form-control" style="min-width: 100px;">
        <option value="easy">ç®€å•</option>
        <option value="medium" selected>ä¸­ç­‰</option>
        <option value="hard">å›°éš¾</option>
        <option value="expert">ä¸“å®¶</option>
      </select>

      <div class="controls-group">
        <button id="newBtn" class="btn">æ–°æ¸¸æˆ</button>
        <button id="resetBtn" class="btn">é‡ç½®</button>
      </div>
    </div>

    <div id="timerArea" class="timer-display">
      <span id="timer">00:00.00</span>
    </div>

    <!-- æ£‹ç›˜ -->
    <div class="board-wrapper">
      <div id="board" aria-label="æ•°ç‹¬æ£‹ç›˜"></div>
    </div>

    <!-- è®°å½•æ¿ -->
    <div id="records">
      <div class="record-header">
        <strong>æœ¬æœºè®°å½•</strong>
        <div id="recordButtons">
          <button id="clearRecords" class="btn btn-sm btn-danger">æ¸…é™¤è®°å½•</button>
        </div>
      </div>
      <div id="recordsList"></div>
    </div>

    <!-- æµ‹è¯•è¯´æ˜ -->
    <div class="demo-info">
      <h2>ğŸ“ æµ‹è¯•æ­¥éª¤</h2>
      <ol>
        <li>ç‚¹å‡»"æ–°æ¸¸æˆ"æŒ‰é’®ç”Ÿæˆé¢˜ç›®</li>
        <li>åœ¨ç©ºç™½æ ¼å­ä¸­è¾“å…¥æ•°å­—ï¼ˆ1-9ï¼‰</li>
        <li>ä½¿ç”¨æ–¹å‘é”®ç§»åŠ¨ç„¦ç‚¹</li>
        <li>è§‚å¯Ÿå†²çªé«˜äº®ï¼ˆé‡å¤æ•°å­—ä¼šå˜çº¢ï¼‰</li>
        <li>è§‚å¯Ÿè®¡æ—¶å™¨è¿è¡Œ</li>
        <li>å¡«å®ŒåæŸ¥çœ‹è®°å½•æ˜¯å¦ä¿å­˜</li>
      </ol>
    </div>

  </div>

<script type="module">
import { generateFullBoard } from './js/core/sudoku-engine.js';
import { digHolesWithValidation } from './js/core/solver.js';
import { initBoardRenderer, renderBoard, readUserBoard } from './js/ui/board-renderer.js';
import { initTimer, startTimer, stopTimer, resetTimer, getElapsedTime, setTimerDisplay } from './js/ui/timer.js';
import { initializeControls, getDifficulty, setLoading } from './js/ui/controls.js';
import { saveRecord, loadRecords, getAllStats } from './js/storage/local-storage.js';
import { on, emit } from './js/utils/event-bus.js';
import { DIFFICULTY_HOLES, DIFFICULTY_LABELS } from './js/config/constants.js';
import { formatTime } from './js/utils/helpers.js';
import { showSuccess, showError, showToast } from './js/ui/toast.js';
import { validateSolution } from './js/core/validator.js';

// æ¸¸æˆçŠ¶æ€
let solution = null;
let puzzle = null;
let givenMask = null;

// åˆå§‹åŒ–
function init() {
  console.log('æ‰¹æ¬¡ 2 æ¼”ç¤ºåˆå§‹åŒ–...');

  initBoardRenderer('#board');
  initTimer('#timer');
  initializeControls();

  // æ³¨å†Œäº‹ä»¶
  on('game:new', handleNewGame);
  on('game:reset', handleReset);
  on('board:complete', handleComplete);
  on('records:clear', handleClearRecords);

  // æ¸²æŸ“ç©ºæ£‹ç›˜
  renderEmptyBoard();
  renderRecords();

  showToast('æ‰¹æ¬¡ 2 æ¼”ç¤ºå·²åŠ è½½ï¼ç‚¹å‡»"æ–°æ¸¸æˆ"å¼€å§‹', 'info');
}

// æ¸²æŸ“ç©ºæ£‹ç›˜
function renderEmptyBoard() {
  const emptyBoard = Array.from({length: 9}, () => Array(9).fill(0));
  const emptyMask = Array.from({length: 9}, () => Array(9).fill(false));
  renderBoard(emptyBoard, emptyMask);
}

// å¤„ç†æ–°æ¸¸æˆ
async function handleNewGame() {
  try {
    setLoading(true);
    stopTimer();
    setTimerDisplay('ç”Ÿæˆä¸­...');

    // å»¶è¿Ÿè®© UI æ›´æ–°
    await new Promise(r => setTimeout(r, 100));

    const difficulty = getDifficulty();
    const holesTarget = DIFFICULTY_HOLES[difficulty];

    console.log(`ç”Ÿæˆ ${DIFFICULTY_LABELS[difficulty]} éš¾åº¦é¢˜ç›®...`);

    solution = generateFullBoard();
    puzzle = digHolesWithValidation(solution, holesTarget);
    givenMask = puzzle.map(row => row.map(cell => cell !== 0));

    renderBoard(puzzle, givenMask);
    resetTimer();
    startTimer();

    setLoading(false);
    showSuccess(`${DIFFICULTY_LABELS[difficulty]} éš¾åº¦é¢˜ç›®å·²ç”Ÿæˆï¼`);
  } catch (error) {
    console.error('ç”Ÿæˆå¤±è´¥:', error);
    showError('ç”Ÿæˆé¢˜ç›®å¤±è´¥ï¼Œè¯·é‡è¯•');
    setLoading(false);
  }
}

// å¤„ç†é‡ç½®
function handleReset() {
  if (!puzzle) return;

  stopTimer();
  renderBoard(puzzle, givenMask);
  resetTimer();
  startTimer();

  showToast('æ¸¸æˆå·²é‡ç½®', 'info');
}

// å¤„ç†å®Œæˆ
function handleComplete() {
  console.log('ğŸ¯ handleComplete è¢«è°ƒç”¨');

  const userBoard = readUserBoard();
  console.log('ç”¨æˆ·æ£‹ç›˜:', userBoard);

  const { isCorrect, errors } = validateSolution(userBoard, solution);
  console.log('éªŒè¯ç»“æœ:', { isCorrect, errors });

  if (isCorrect) {
    stopTimer();
    const elapsed = getElapsedTime();
    const difficulty = getDifficulty();

    console.log('å®Œæˆä¿¡æ¯:', {
      difficulty,
      elapsed,
      formatted: formatTime(elapsed)
    });

    saveRecord(difficulty, elapsed);
    renderRecords();

    showSuccess(`æ­å–œå®Œæˆï¼ç”¨æ—¶ï¼š${formatTime(elapsed)}`);
  } else {
    console.log('ç­”æ¡ˆé”™è¯¯:', errors);
    showError('ç­”æ¡ˆä¸æ­£ç¡®ï¼Œè¯·æ£€æŸ¥');
  }
}

// å¤„ç†æ¸…é™¤è®°å½•
function handleClearRecords() {
  renderRecords();
  showToast('è®°å½•å·²æ¸…é™¤', 'info');
}

// æ¸²æŸ“è®°å½•
function renderRecords() {
  const stats = getAllStats();
  const recordsList = document.getElementById('recordsList');

  if (!recordsList) return;

  const html = ['easy', 'medium', 'hard', 'expert'].map(diff => {
    const stat = stats[diff];
    const bestStr = stat.best ? formatTime(stat.best) : 'â€”';
    const lastStr = stat.lastTime ? formatTime(stat.lastTime) : 'â€”';
    const label = DIFFICULTY_LABELS[diff];

    return `
      <div class="record-row">
        <div>${label} <span class="small">ï¼ˆæœ€è¿‘ï¼š${lastStr}ï¼‰</span></div>
        <div>æœ€å¥½ï¼š${bestStr}</div>
      </div>
    `;
  }).join('');

  recordsList.innerHTML = html;
}

// å¯åŠ¨
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', init);
} else {
  init();
}
</script>

</body>
</html>
